<html>
   <head>
      <script type="text/javascript" src="../../libraries/d3/d3.v3.min.js"></script>
      <script type="text/javascript" src="../../libraries/d3/topojson.v1.min.js"></script>
      <script type="text/javascript" src="../../libraries/jquery/jquery-1.10.2.js"></script>
      <script type="text/javascript" src="../../libraries/jquery-ui-1.10.3/ui/jquery-ui.js"></script>      
      <!-- <script type="text/javascript" src="../../libraries/chroma.js-master/chroma.min.js"></script> -->
      <script type="text/javascript" src="./ipps_display_helper.js"></script>
      <link rel="stylesheet" type="text/css" href="./ipps_display.css" />
      <link rel="stylesheet" type="text/css" href="../../libraries/jquery-ui-1.10.3/themes/base/jquery-ui.css" />

      <title>Nearest Point Selection along County Border</title>
   </head>
   <body>
      <script>
         var width = 1200, height = 900;
         var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);
         var container_g = svg.append("g").attr("id", "container_g");
         // Clip path to gradient circle to show which "closest point" it belongs to
         // Dropdown selection from a set of examples //
         // var example_providers = ["140012", "140110", "140155", "140161", "140186"];

         var defs = svg.append("defs");

         var example_providers = ["140161"];
         example_providers.forEach(function(ccn_iter) {
            d3.csv("distances/drive_distances_for_" + ccn_iter + ".csv", function(error, dist_data) {
               console.log(dist_data)
               dist_data.forEach(function(d) {
                  if (d.driving_dist == "no results") { 
                     d.driving_dist = "999999999 mi"; 
                  }
                  d.driving_dist = d.driving_dist.slice(0,-3)
                  d.driving_dist_num = +d.driving_dist
               })
               ccn_pos = [+dist_data[0].ccn_lng, +dist_data[0].ccn_lat]
               // Get used to some on-the-fly calculations using d3.
               
               var us_projection = d3.geo.albers()
                  .scale(20000)
                  .translate([-1800,1600]);

               var circle_x = us_projection(ccn_pos)[0]
               var circle_y = us_projection(ccn_pos)[1]

               container_g.append("circle")
                  .attr("cx", function() { return +us_projection(ccn_pos)[0]; })
                  .attr("cy", function() { return +us_projection(ccn_pos)[1]; })
                  .attr("fill", "#cc181e")
                  .attr("r", 4);

               d3.json("data/topojson/topo_counties_for_" + ccn_iter + ".json", function(error, us_counties) {
                  var county_list = [];
                  topojson.feature(us_counties, us_counties.objects["counties_for_" + ccn_iter]).features.forEach(function(d) { county_list.push(d.id) })

                  var geo_line_creator = d3.geo.path()
                     .projection(us_projection);

                  var closest_points_by_county = []
                  county_list.forEach(function(d) {
                     var chk_counties = topojson.mesh(us_counties, us_counties.objects["counties_for_" + ccn_iter], function(a, b) { return (a.id == d) || (b.id == d); })
                     container_g.append("path")
                        .datum(chk_counties)
                        .attr("id", function() { return "fips_" + d; })
                        .attr("stroke", "#666")
                        .attr("fill", "none")
                        .attr("d", geo_line_creator)

                     defs.append("path")
                        .attr("id", function() { return "county_" + d; })
                        .datum(chk_counties)
                        .attr("d", geo_line_creator);

                     defs.append("clipPath")
                        .attr("id", function() { return "clip_" + d; })
                        .append("use")
                        .attr("xlink:href", function() { return "#county_" + d; });

                     current_county = d;
                     var county_data = dist_data.filter(function(d) { return d.county == String(current_county); })
                     var sorted_county_data = county_data.sort(function(a,b) { return a.driving_dist_num < b.driving_dist_num ? -1 : 1; })
                     var closest_drive_pt = [+sorted_county_data[0].county_border_lng, +sorted_county_data[0].county_border_lat]
                     var sorted_county_data = county_data.sort(function(a,b) { return +a.distance < +b.distance ? -1 : 1; })
                     var closest_straight_pt = [+sorted_county_data[0].county_border_lng, +sorted_county_data[0].county_border_lat]
                     var obj_closest_to_county = {"county": current_county, "closest_drive_pt": closest_drive_pt, "closest_straight_pt": closest_straight_pt}
                     closest_points_by_county.push(obj_closest_to_county)
                  })
                  console.log(closest_points_by_county)
                  var close_pts_container = container_g.append("g")

                  close_pts_container.selectAll("circle#straight_dist_pts").data(closest_points_by_county)
                     .enter().append("circle").attr("id", "straight_dist_pts")
                     .attr("id", function(d) { return "county_pt_" + d.county; })
                     .attr("cx", function(d) { return +us_projection(d.closest_straight_pt)[0]; })
                     .attr("cy", function(d) { return +us_projection(d.closest_straight_pt)[1]; })
                     .attr("r", 8)
                     .style("opacity", 0.5)
                     .attr("fill", "green");
                  close_pts_container
                     .attr("clip-path", "url(#clip_17093)")

                  
                  
                  
                  
                  
                  container_g.selectAll("circle#straight_dist_pts").data(closest_points_by_county)
                     .enter().append("circle").attr("id", "straight_dist_pts")
                     .attr("id", function(d) { return "county_pt_" + d.county; })
                     .attr("cx", function(d) { return +us_projection(d.closest_straight_pt)[0]; })
                     .attr("cy", function(d) { return +us_projection(d.closest_straight_pt)[1]; })
                     .attr("r", 3)
                     .style("opacity", 0.5)
                     .attr("fill", "green");


                  container_g.selectAll("circle#drive_dist_pts").data(closest_points_by_county)
                     .enter().append("circle").attr("id", "drive_dist_pts")
                     .attr("id", function(d) { return "county_pt_" + d.county; })
                     .attr("cx", function(d) { return +us_projection(d.closest_drive_pt)[0]; })
                     .attr("cy", function(d) { return +us_projection(d.closest_drive_pt)[1]; })
                     .attr("r", 3)
                     .style("opacity", 0.5)
                     .attr("fill", "orange");
                  /*
                  county_list.forEach(function(d) {
                     container_g.selectAll("circle#county_pt_" + d)
                        .append("use")
                        .attr("xlink:href", function() { return "#clip_" + d; });
                  })
                  */
               })
            }) 
         })

         /*
         var voronoi = d3.geom.voronoi()
            .clipExtent([[-2, -2], [width + 2, height + 2]]);

         var cell = svg.append("g")
             .attr("class", "voronoi")
           .selectAll("g");

         cell = cell.data(voronoi(sampled_pts));
         cell.exit().remove();
         var cellEnter = cell.enter().append("g");
         cellEnter.append("circle").attr("r", 3.5);
         cellEnter.append("path");
         cell.select("circle").attr("transform", function(d) { return "translate(" + d + ")"; });
         cell.select("path").attr("d", function(d) { return "M" + d.join("L") + "Z"; })
            .attr("stroke-width", 1)
            .attr("stroke", "#999")
            .attr("fill","none");
         */
      </script>
   </body>
</html>
